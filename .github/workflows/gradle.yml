name: Java CI with Gradle

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ JDK 17 ì„¤ì¹˜
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3ï¸âƒ£ Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for Gradle wrapper
        run: chmod +x gradlew

      # 4ï¸âƒ£ Gradle ë¹Œë“œ
      - name: Build with Gradle
        run: ./gradlew clean build --stacktrace

      # 5ï¸âƒ£ JUnit í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run tests
        run: ./gradlew test --info

      # 6ï¸âƒ£ í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-test-report
          path: build/reports/tests/test

      # 7ï¸âƒ£ Discord ì•Œë¦¼ ë³´ë‚´ê¸° (ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‘)
      - name: Send Discord notification
        if: always()  # ë¬´ì¡°ê±´ ì‹¤í–‰
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          STATUS: ${{ job.status }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          COMMIT: ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ "$STATUS" == "success" ]; then
            COLOR=3066993  # ğŸŸ© Green
            EMOJI="âœ…"
            TITLE="Build Succeeded"
          else
            COLOR=15158332  # ğŸŸ¥ Red
            EMOJI="âŒ"
            TITLE="Build Failed"
          fi

          # Discord ë©”ì‹œì§€ JSON ì‘ì„±
          PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg desc "$EMOJI **$REPO**\nBranch: \`$BRANCH\`\nCommit: \`$COMMIT\`\n[View Logs]($RUN_URL)" \
            --argjson color $COLOR \
            '{embeds: [{title: $title, description: $desc, color: $color}]}')

          # Discordë¡œ ì „ì†¡
          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$WEBHOOK_URL"
